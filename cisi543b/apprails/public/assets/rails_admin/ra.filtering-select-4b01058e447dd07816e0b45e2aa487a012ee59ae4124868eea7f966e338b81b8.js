!function(l){"use strict";l.widget("ra.filteringSelect",{options:{createQuery:function(t){return{query:t}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},button:null,input:null,select:null,filtering_select:null,_create:function(){return this.filtering_select=this.element.siblings('[data-input-for="'+this.element.attr("id")+'"]'),0<this.filtering_select.length?(this.input=this.filtering_select.children("input"),this.button=this.filtering_select.children(".input-group-btn")):(this.element.hide(),this.filtering_select=this._inputGroup(this.element.attr("id")),this.input=this._inputField(),this.button=this._buttonField()),this._setOptionsSource(),this._initAutocomplete(),this._initKeyEvent(),this._overloadRenderItem(),this._autocompleteDropdownEvent(this.button),this.filtering_select.append(this.input).append(this.button).insertAfter(this.element)},_getResultSet:function(n,t,s){var o=new RegExp(l.ui.autocomplete.escapeRegex(n.term),"i"),i=function(t){return l("<span>").text(t).html()},r=function(t,e){return e.length?l.map(t.split(e),function(t){return i(t)}).join(l("<strong>").text(e)[0].outerHTML):i(t)};return l.map(t,function(t){var e=t.id||t.value,i=t.label||t.id;if(e&&(s||o.test(t.label)))return{html:r(i,n.term),value:i,id:e}})},_getSourceFunction:function(n){var s=this,o=0;return l.isArray(n)?function(t,e){e(s._getResultSet(t,n,!1))}:"string"==typeof n?function(e,i){this.xhr&&this.xhr.abort(),this.xhr=l.ajax({url:n,data:s.options.createQuery(e.term),dataType:"json",autocompleteRequest:++o,success:function(t){this.autocompleteRequest===o&&i(s._getResultSet(e,t,!0))},error:function(){this.autocompleteRequest===o&&i([])}})}:n},_setOptionsSource:function(){this.options.xhr?this.options.source=this.options.remote_source:this.options.source=this.element.children("option").map(function(){return{label:l(this).text(),value:this.value}}).toArray()},_buttonField:function(){return l('<span class="input-group-btn"><label class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Show All Items" role="button"><span class="caret"></span><span class="ui-button-text">&nbsp;</span></label></span>')},_autocompleteDropdownEvent:function(t){var e=this;return t.click(function(){e.input.autocomplete("widget").is(":visible")?e.input.autocomplete("close"):(e.input.autocomplete("search",""),e.input.focus())})},_inputField:function(){var t,e=this.element.children(":selected"),i=e.val()?e.text():"";return t=l('<input type="text">').val(i).addClass("form-control ra-filtering-select-input").attr("style",this.element.attr("style")).show(),this.element.attr("placeholder")&&t.attr("placeholder",this.element.attr("placeholder")),this.element.attr("required")&&(t.attr("required",this.element.attr("required")),this.element.attr("required",!1)),t},_inputGroup:function(t){return l("<div>").addClass("input-group filtering-select col-sm-2").attr("data-input-for",t).css("float",this.element.css("float"))},_initAutocomplete:function(){var s=this;return this.input.autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(t,e){var i=l("<option>").attr("value",e.item.id).attr("selected","selected").text(e.item.value);s.element.html(i).trigger("change",e.item.id),s._trigger("selected",t,{item:i}),l(s.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(t,e){if(!e.item){var i=new RegExp("^"+l.ui.autocomplete.escapeRegex(l(this).val())+"$","i"),n=!1;if(s.element.children("option").each(function(){if(l(this).text().match(i))return!(n=!0)}),!n&&""===l(this).val())return l(this).val(null),s.element.html(l('<option value="" selected="selected"></option>')),s.input.data("ui-autocomplete").term="",l(s.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}})},_initKeyEvent:function(){var t=this;return this.input.keyup(function(){if(!l(this).val().length)return t.element.html(l('<option value="" selected="selected"></option>')).trigger("change")})},_overloadRenderItem:function(){this.input.data("ui-autocomplete")._renderItem=function(t,e){return l("<li></li>").data("ui-autocomplete-item",e).append(l("<a></a>").html(e.html||e.id)).appendTo(t)}},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),this.filtering_select.remove(),l.Widget.prototype.destroy.call(this)}})}(jQuery);